
MACRO OMEGA [ABS [APP [REF 1] [REF 1]]];;

MACRO NULL [DATA []];;

MACRO CAAR [ABS [CAR [CAR [REF 1]]]];;
MACRO CADR [ABS [CAR [CDR [REF 1]]]];;

MACRO EQUALS 
  [ABS [ABS [APP [APP [PRIM [DATA BRANCH] [PRIM [DATA AND] [CONS [IS_PRIMITIVE [REF 1]] [IS_PRIMITIVE [REF 2]]]]] [PRIM [DATA DATA_EQUALS] [CONS [REF 1] [REF 2]]]] [DATA FALSE]]]]
;;
  
MACRO MAP_PUT // MAP, KEY, VAL
  [ABS [ABS [ABS [CONS [CONS [REF 2] [CONS [REF 1] [DATA []]]] [REF 3]]]]]
;;

MACRO MAP_GET // MAP, KEY, DEFAULT
  [APP [ABS [APP [REF 1] [REF 1]]] [ABS [ABS [ABS [ABS [APP [APP [PRIM [DATA BRANCH] [APP [APP [ABS [ABS [APP [APP [PRIM [DATA BRANCH] [PRIM [DATA AND] [CONS [IS_PRIMITIVE [REF 1]] [IS_PRIMITIVE [REF 2]]]]] [PRIM [DATA DATA_EQUALS] [CONS [REF 1] [REF 2]]]] [DATA FALSE]]]] [DATA []]] [REF 3]]] [REF 1]] [APP [APP [PRIM [DATA BRANCH] [APP [APP [ABS [ABS [APP [APP [PRIM [DATA BRANCH] [PRIM [DATA AND] [CONS [IS_PRIMITIVE [REF 1]] [IS_PRIMITIVE [REF 2]]]]] [PRIM [DATA DATA_EQUALS] [CONS [REF 1] [REF 2]]]] [DATA FALSE]]]] [REF 2]] [APP [ABS [CAR [CAR [REF 1]]]] [REF 3]]]] [CAR [CDR [CAR [REF 3]]]]] [APP [APP [APP [APP [REF 4] [REF 4]] [CDR [REF 3]]] [REF 2]] [REF 1]]]]]]]]]
;;          

MACRO GRAMMAR [DATA [
  [ "ROOT"
    "STATEMENT"
    ["SEQ" [["NON_TERM" "STATEMENT"]]]
  ]
  
  [ "STATEMENT"
    "REDUCE"
    ["SEQ" [["TERM" "REDUCE"] ["NON_TERM" "LOBJECT"]]]
  ]

  [ "STATEMENT"
    "SET_PARSER"
    ["SEQ" [["TERM" "SET_PARSER"] ["NON_TERM" "LOBJECT"]]]
  ]
  
  [ "STATEMENT"
    "SET_ENV"
    ["SEQ" [["TERM" "SET_ENV"] ["NON_TERM" "LOBJECT"]]]
  ]
  
  [ "LOBJECT"
    "PRIM_GET"
    ["SEQ" [["VALUE" "PrimIdent"] ["VALUE" "PrimIdent"]]]
  ]
]];;

MACRO VISITOR_MAP (*NULL*);;

MACRO VISITOR_MAP [APP [APP [APP (*MAP_PUT*) (*VISITOR_MAP*)]
  [DATA "STATEMENT"]]
  [ABS // PARSE_NODE
  [ABS // CHILDREN
    [APP [REF 2] [CAR [REF 1]]]
  ]]
]
;;

MACRO PARSE_NODE 
  [APP (*OMEGA*) // RECURSIVE
    [ABS // SELF
    [ABS // NODE
      [APP [APP
        [APP [APP [APP (*MAP_GET*) // Get visitor func 
          (*VISITOR_MAP*)]
          [CAR [REF 1]]]
          (*NULL*)]
        [REF 2]]
        [CAR [CDR [REF 1]]]]
    ]]
 ];;

REDUCE [APP (*PARSE_NODE*)
  [PRIM [DATA PARSE_STATEMENT] [CONS (*GRAMMAR*) [DATA "REDUCE APP ABS"]]]];;
